<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<html>
<head th:replace="~{fragments/header :: header}"/>
<style>
@charset "UTF-8";

*{
	box-sizing: border-box;
}

#chatt{
	width: 800px;
	margin: 20px auto;
	margin-bottom: 200px;
    border: 1px solid;
    background-color : #9bbbd4;
}

#chatt #talk{
	width: 800px;
	height: 800px;
	overflow: scroll;
	border : 1px solid #aaa;
}

#chatt #msg{
	width: 737px;
	height:100px;
	display: inline-block;
}

#chatt #sendZone > *{
	vertical-align: top;

}
#chatt #btnSend{
	width: 56px;
	height: 100px;
}

#chatt #talk div{
	width: 70%;
	display: inline-block;
	padding: 6px;
	border-radius:10px;
}

#chatt .me{
	float: right;
	text-align: right;
	background-color : #fef01b;
	margin : 1px 0px 2px 30%;
}

#chatt .other{
    float: left;
	background-color : #ffffff;
	margin : 2px;
}
.forMarginTop {
	margin-top : 25px;
    text-align: center;
}
.chat-menu {
    background-color : #9bbbd4;
}
</style>
<body>
<div th:replace="~{fragments/bodyHeader :: bodyHeader}"/>
<div class="hero bg-dark text-center py-5">
    <h1 class="text-white">YouthTing</h1>
    <h2 class="text-white">대학생들을 위한 미팅 서비스</h2>
</div>
<div id='chatt'>
    <nav class="navbar navbar-light bg-light">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">YouthTing</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                    aria-controls="navbarDropdown" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <form th:action="@{/meeting/showMap}" method="get">
                            <button class="btn nav-link" type="submit" aria-expanded="false">
                                미팅장소 검색
                            </button>
                        </form>
                    </li>
                    <li class="nav-item dropdown">
                        <form th:action="@{/meeting/exit}" method="post">
                            <button class="btn nav-link" type="submit" aria-expanded="false">
                                채팅룸 퇴장
                            </button>
                        </form>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    <span><h2 th:text="${roomName}" class="forMarginTop">WebSocket Chatting</h2></span>
    <!--    &lt;!&ndash;여기  &ndash;&gt; 에 메뉴 바를 만드는 것부터 다시 하자-->
    <input type='text' th:value="${sender}" id='sender' hidden="hidden">
    <br/>
    <div id='talk'>
        <div th:attr="class=${chatting.userId == myId ? 'me' : 'other'}" th:each="chatting : ${chatList}">
            <span><img th:src="|/user/profile/${chatting.storeProfileName}|" width="50" height="50"/></span>
            <span><b th:text="${chatting.sender} "></b></span><span th:text="| [ ${chatting.time} ]|"></span><br/>
            <span th:text="${chatting.content}" class="talkBox"></span>
        </div>
    </div>
    <div id='sendZone'>
        <textarea id='msg' value='hi...'></textarea>
        <input type='button' value='전송' id='btnSend'>
    </div>
</div>
</body>
<script type="text/javascript">
function getId(id){
	return document.getElementById(id);
}

var data = {};//전송 데이터(JSON)

var ws ;
<!--var roomId = getId('roomId');-->
<!--var myId = getId('myId');-->
var sender = getId('sender');
var btnSend = getId('btnSend');
var talk = getId('talk');
var msg = getId('msg');

window.onload = function () {
    ws = new WebSocket("ws://" + location.host + "/ws/chat");
    talk.scrollTop=talk.scrollHeight;

    	ws.onmessage = function(msg){ // 함수 안의 함수, 얘는 따로 작동할 수도 있다는 것.
		var data = JSON.parse(msg.data);
		var css;

		if(data.sender == sender.value){
			css = 'class=me';
		}else{
			css = 'class=other';
		}

		var item = `<div ${css} >
		<span><img src="${data.storeProfileUrl}" width="50" height="50"/></span>
		                <span><b>${data.sender}</b></span> [ ${data.time} ]<br/>
                      <span>${data.content}</span>
						</div>`;

		talk.innerHTML += item;
		talk.scrollTop=talk.scrollHeight;//스크롤바 하단으로 이동
	}
}



msg.onkeyup = function(ev){
	if(ev.keyCode == 13){
		send();
	}
}

btnSend.onclick = function(){
	send();
}

function send(){
	     // data.mid 라는 걸 새로 지정해준 거, 이런식으로 선언할 수 있음
<!--        data.roomNum = roomId.value;-->
<!--        data.sender = sender.value;-->
<!--        data.userId = myId.value;-->
		data.content = msg.value;
		data.time = new Date().toLocaleString();
		var temp = JSON.stringify(data);
		ws.send(temp);
	msg.value ='';
}

</script>
</html>
</html>